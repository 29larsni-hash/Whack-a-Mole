<!DOCTYPE html>
<html>
<head>
    <title>VR Whack-a-Mole Game</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <style>
        #gameUI {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-family: Arial;
            font-size: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="gameUI">
        <div>Score: <span id="score">0</span></div>
        <div>Time: <span id="timer">60</span>s</div>
    </div>

    <a-scene embedded style="height: 100vh;">
        <!-- Assets -->
        <a-assets>
            <a-mixin id="mole-cube" 
                     geometry="primitive: box; width: 1; height: 1; depth: 1"
                     material="color: brown"
                     animation__popup="property: position; dur: 500; easing: easeOutQuad; startEvents: popup"
                     animation__hide="property: position; dur: 300; easing: easeInQuad; startEvents: hide">
            </a-mixin>
        </a-assets>

        <!-- Environment -->
        <a-sky color="#87CEEB"></a-sky>
        <a-plane position="0 0 0" rotation="-90 0 0" width="25" height="25" color="#228B22"></a-plane>
        
        <!-- Lighting -->
        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="directional" position="0 10 0" color="#ffffff"></a-light>

        <!-- Camera with cursor for gaze interaction -->
        <a-camera position="0 1.6 4">
            <a-cursor 
                geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                material="color: white; shader: flat"
                raycaster="objects: .mole"
                fuse="true"
                fuse-timeout="1000">
            </a-cursor>
        </a-camera>
    </a-scene>

    <script>
        // Game variables
        let score = 0;
        let timeLeft = 60;
        let gameActive = false;
        let activeMoles = [1000];
        let gameTimer;
        let spawnTimer;

        // Get UI elements
        const scoreElement = document.getElementById('score');
        const timerElement = document.getElementById('timer');

        // Mole spawn positions - using coordinates directly
        const spawnPositions = [
            { id: 'pos1', x: -4, y: -0.5, z: -1 },
            { id: 'pos2', x: -2, y: -0.5, z: -1 },
            { id: 'pos3', x: 0, y: -0.5, z: -1 },
            { id: 'pos4', x: 2, y: -0.5, z: -1 },
            { id: 'pos5', x: 4, y: -0.5, z: -1 },
            
        ];

        // Create a mole at specified position
        function createMole(spawnPoint) {
            const mole = document.createElement('a-entity');
            const hiddenY = spawnPoint.y;
            const popupY = 1;
            
            // Set up the mole with proper attributes
            mole.setAttribute('mixin', 'mole-cube');
            mole.setAttribute('position', `${spawnPoint.x} ${hiddenY} ${spawnPoint.z}`);
            mole.setAttribute('class', 'mole');
            mole.setAttribute('data-spawn-id', spawnPoint.id);

            // Set up animations with correct target positions
            mole.setAttribute('animation__popup', 
                `property: position; to: ${spawnPoint.x} ${popupY} ${spawnPoint.z}; dur: 500; easing: easeOutQuad; startEvents: popup`);
            mole.setAttribute('animation__hide', 
                `property: position; to: ${spawnPoint.x} ${hiddenY} ${spawnPoint.z}; dur: 300; easing: easeInQuad; startEvents: hide`);

            // Add event listeners
            mole.addEventListener('click', hitMole);
            mole.addEventListener('fusing', startFusing);
            mole.addEventListener('fused', hitMole);

            // Add to scene
            document.querySelector('a-scene').appendChild(mole);
            
            // Trigger popup animation after short delay
            setTimeout(() => {
                if (mole.parentNode) {
                    mole.emit('popup');
                }
            }, 100);

            return mole;
        }

        // Handle mole hit
        function hitMole(event) {
            if (!gameActive) return;
            
            const mole = event.target;
            if (!mole.classList.contains('mole')) return;
            
            score += 10;
            scoreElement.textContent = score;
            
            // Change color to show hit
            mole.setAttribute('material', 'color', 'red');
            
            // Remove mole after short delay
            setTimeout(() => {
                removeMole(mole);
            }, 200);
        }

        // Handle fuse start (visual feedback for gaze)
        function startFusing(event) {
            const mole = event.target;
            if (mole.classList.contains('mole')) {
                mole.setAttribute('material', 'color', 'yellow');
            }
        }

        // Remove mole from scene
        function removeMole(mole) {
            if (mole && mole.parentNode) {
                // Trigger hide animation
                mole.emit('hide');
                
                // Remove from scene after animation completes
                setTimeout(() => {
                    if (mole.parentNode) {
                        mole.parentNode.removeChild(mole);
                    }
                }, 350);
            }
            
            // Remove from active moles array
            const index = activeMoles.indexOf(mole);
            if (index > -1) {
                activeMoles.splice(index, 1);
            }
        }

        // Spawn random mole
        function spawnRandomMole() {
            if (!gameActive || activeMoles.length >= 4) return;
            
            // Find available positions
            const availablePositions = spawnPositions.filter(pos => {
                return !activeMoles.some(mole => 
                    mole.getAttribute('data-spawn-id') === pos.id
                );
            });
            
            if (availablePositions.length === 0) return;
            
            // Pick random position
            const randomPosition = availablePositions[Math.floor(Math.random() * availablePositions.length)];
            const mole = createMole(randomPosition);
            activeMoles.push(mole);
            
            // Auto-remove mole after 2-3 seconds if not hit
            setTimeout(() => {
                if (mole.parentNode && activeMoles.includes(mole)) {
                    removeMole(mole);
                }
            }, 2000 + Math.random() * 1000);
        }

        // Game timer
        function updateTimer() {
            if (!gameActive) return;
            
            timeLeft--;
            timerElement.textContent = timeLeft;
            
            if (timeLeft <= 0) {
                endGame();
            }
        }

        // End game
        function endGame() {
            gameActive = false;
            
            // Clear intervals to prevent memory leaks
            if (gameTimer) clearInterval(gameTimer);
            if (spawnTimer) clearInterval(spawnTimer);
            
            // Clean up remaining moles
            activeMoles.forEach(mole => removeMole(mole));
            activeMoles = [];
            
            // Show final score after short delay
            setTimeout(() => {
                alert(`Game Over! Final Score: ${score}`);
            }, 500);
        }

        // Start the game
        function startGame() {
            console.log('VR Whack-a-Mole Game Started!');
            gameActive = true;
            
            // Spawn moles at random intervals
            spawnTimer = setInterval(() => {
                spawnRandomMole();
            }, 800 + Math.random() * 1000);
            
            // Update timer every second
            gameTimer = setInterval(updateTimer, 1000);
        }

        // Initialize game when scene loads
        document.querySelector('a-scene').addEventListener('loaded', () => {
            console.log('Scene loaded, starting game in 2 seconds...');
            setTimeout(startGame, 2000);
        });
    </script>
</body>
</html>
